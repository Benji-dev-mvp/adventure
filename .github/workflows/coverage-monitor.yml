name: Coverage Monitor (Automated)

on:
  schedule:
    # Run daily at 9 AM UTC to analyze coverage trends
    - cron: '0 9 * * *'
  workflow_dispatch: # Manual trigger

jobs:
  coverage-analysis:
    name: Automated Coverage Analysis
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for trend analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: npm

      - name: Install frontend dependencies
        run: npm ci

      - name: Run frontend tests with coverage
        run: npm run test:ci
        continue-on-error: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install backend dependencies
        working-directory: backend
        run: |
          pip install -r requirements.txt

      - name: Run backend tests with coverage
        working-directory: backend
        env:
          DATABASE_URL: 'sqlite:///:memory:'
          SECRET_KEY: test-secret-key
          AI_PROVIDER: mock
        run: pytest -v --cov=app --cov-report=xml --cov-report=term
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: automated-check
          name: automated-coverage-check

      - name: Generate coverage report
        run: |
          echo "## Daily Coverage Report" > coverage-report.md
          echo "Generated: $(date)" >> coverage-report.md
          echo "" >> coverage-report.md
          echo "View full report: https://app.codecov.io/gh/${{ github.repository }}" >> coverage-report.md

      - name: Create issue if coverage dropped significantly
        uses: actions/github-script@v7
        with:
          script: |
            // This will be enhanced by Codecov AI to detect drops
            const message = `
            ## ðŸ¤– Automated Coverage Analysis

            Daily coverage check completed. 

            ðŸ“Š View detailed analysis: https://app.codecov.io/gh/${{ github.repository }}

            This is an automated check. Codecov AI will flag any significant drops.
            `;

            console.log(message);

  dependency-coverage-check:
    name: Check Coverage on Dependency Updates
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.actor == 'dependabot[bot]'

    steps:
      - uses: actions/checkout@v4

      - name: Run full test suite
        run: |
          npm ci
          npm run test:ci

      - name: Auto-approve if coverage maintained
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: 'âœ… Automated approval: Coverage checks passed'
            });
